name: Deploy AiVedha Guardian to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_lambdas:
        description: 'Deploy Lambda functions'
        type: boolean
        default: false
      deploy_frontend:
        description: 'Deploy frontend'
        type: boolean
        default: true
      deploy_region:
        description: 'Deploy region (us-east-1, ap-south-1, or both)'
        type: choice
        options:
          - both
          - us-east-1
          - ap-south-1
        default: 'both'
      run_security_audit:
        description: 'Run post-deployment security audit'
        type: boolean
        default: true
      skip_version_increment:
        description: 'Skip version increment'
        type: boolean
        default: false

env:
  # Primary Region (USA)
  AWS_REGION_US: us-east-1
  # Secondary Region (India)
  AWS_REGION_IN: ap-south-1
  # Default region for non-regional resources
  AWS_REGION: us-east-1
  # S3 and CloudFront (Global - single region)
  S3_BUCKET: aivedha-ai-website
  CLOUDFRONT_DISTRIBUTION_ID: EDCUM1WH3G69U
  # Build tools
  NODE_VERSION: '22'
  PYTHON_VERSION: '3.11'
  # Static IPs for audit verification
  USA_STATIC_IP: '44.206.201.117'
  INDIA_STATIC_IP: '13.203.153.119'
  # Alert email
  ALERT_EMAIL: 'aravind@aivibe.in'

jobs:
  # =============================================================================
  # VERSION INCREMENT (Auto-increment on every push)
  # =============================================================================
  increment-version:
    name: Increment API Version
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_version_increment != 'true'
    outputs:
      new_version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Increment Version
        id: version
        run: |
          node scripts/increment-version.cjs --type patch
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "New version: $VERSION"

      - name: Commit Version Update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add package.json src/types/audit.types.ts
          git diff --staged --quiet || git commit -m "chore: bump version to ${{ steps.version.outputs.version }} [skip ci]"
          git push || echo "No changes to push"

  # =============================================================================
  # PRE-DEPLOYMENT VALIDATION
  # =============================================================================
  validate:
    name: Validate Code & API Consistency
    runs-on: ubuntu-latest
    needs: increment-version
    if: always() && (needs.increment-version.result == 'success' || needs.increment-version.result == 'skipped')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: Run TypeScript Check
        id: typescript
        run: |
          echo "Running TypeScript type check..."
          npx tsc --noEmit 2>&1 | tee typescript-output.txt
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "typescript_errors=true" >> $GITHUB_OUTPUT
            echo "::error::TypeScript compilation failed"
          else
            echo "typescript_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: Run ESLint
        id: lint
        run: |
          echo "Running ESLint..."
          npm run lint 2>&1 | tee lint-output.txt || true

      - name: Validate API Consistency
        id: api_consistency
        run: |
          echo "Validating API parameter consistency..."
          node scripts/validate-api-consistency.cjs 2>&1 | tee api-consistency-output.txt
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "api_errors=true" >> $GITHUB_OUTPUT
            echo "::error::API consistency validation failed"
          else
            echo "api_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Validation Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: |
            typescript-output.txt
            lint-output.txt
            api-consistency-output.txt
          retention-days: 7

      - name: Check Validation Results
        if: steps.typescript.outputs.typescript_errors == 'true' || steps.api_consistency.outputs.api_errors == 'true'
        run: |
          echo "Validation failed!"
          exit 1

  # =============================================================================
  # FRONTEND DEPLOYMENT (Single region - CloudFront global)
  # =============================================================================
  deploy-frontend:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest
    needs: validate
    if: |
      always() &&
      needs.validate.result == 'success' &&
      github.event.inputs.deploy_frontend != 'false'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Clean Previous Build Artifacts
        run: |
          echo "Cleaning previous build artifacts..."
          rm -rf node_modules dist .cache .vite .parcel-cache build coverage .turbo
          rm -f package-lock.json.cache

      - name: Install Dependencies
        run: |
          echo "Installing fresh dependencies..."
          npm ci --legacy-peer-deps

      - name: Build Production Bundle
        run: |
          echo "Building production bundle..."
          npm run build
        env:
          CI: false
          VITE_API_URL: https://api.aivedha.ai/api
          VITE_APP_URL: https://aivedha.ai
          # OAuth Configuration - Public Client IDs
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          VITE_GITHUB_CLIENT_ID: ${{ secrets.VITE_GITHUB_CLIENT_ID }}
          VITE_GITHUB_REDIRECT_URI: ${{ secrets.VITE_GITHUB_REDIRECT_URI }}
          # PayPal Configuration - Public Client ID
          VITE_PAYPAL_CLIENT_ID: ${{ secrets.VITE_PAYPAL_CLIENT_ID }}
          # reCAPTCHA Configuration - Public Site Key
          VITE_RECAPTCHA_SITE_KEY: ${{ secrets.VITE_RECAPTCHA_SITE_KEY }}
          # API keys from AWS Secrets Manager (us-east-1) via GitHub Secrets
          VITE_AIVEDHA_API_KEY_US: ${{ secrets.VITE_AIVEDHA_API_KEY_US }}
          VITE_AIVEDHA_API_KEY_INDIA: ${{ secrets.VITE_AIVEDHA_API_KEY_INDIA }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        run: |
          echo "Deploying to S3..."

          # Deploy all static assets with long cache
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }} \
            --delete \
            --cache-control "max-age=31536000" \
            --exclude "*.html" \
            --exclude "sitemap.xml" \
            --exclude "robots.txt"

          # Upload HTML files with no-cache
          for file in dist/*.html; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              aws s3 cp "$file" "s3://${{ env.S3_BUCKET }}/$filename" \
                --cache-control "no-cache, no-store, must-revalidate" \
                --content-type "text/html"
            fi
          done

          # Upload sitemap with short cache
          if [ -f "dist/sitemap.xml" ]; then
            aws s3 cp dist/sitemap.xml s3://${{ env.S3_BUCKET }}/sitemap.xml \
              --cache-control "max-age=3600" \
              --content-type "application/xml"
          fi

          # Upload robots.txt with short cache
          if [ -f "dist/robots.txt" ]; then
            aws s3 cp dist/robots.txt s3://${{ env.S3_BUCKET }}/robots.txt \
              --cache-control "max-age=3600" \
              --content-type "text/plain"
          fi

      - name: Invalidate CloudFront Cache
        run: |
          echo "Invalidating CloudFront cache..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "Invalidation ID: $INVALIDATION_ID"

      - name: Frontend Deployment Summary
        run: |
          echo "=========================================="
          echo "FRONTEND DEPLOYMENT COMPLETE!"
          echo "=========================================="
          echo "Website: https://aivedha.ai"
          echo "S3 Bucket: ${{ env.S3_BUCKET }}"
          echo "CloudFront: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}"
          echo "=========================================="

  # =============================================================================
  # DETECT CHANGED LAMBDA FILES
  # =============================================================================
  detect-changes:
    name: Detect Changed Lambda Files
    runs-on: ubuntu-latest
    outputs:
      security-crawler: ${{ steps.changes.outputs.security-crawler }}
      audit-status: ${{ steps.changes.outputs.audit-status }}
      report-generator: ${{ steps.changes.outputs.report-generator }}
      url-validator: ${{ steps.changes.outputs.url-validator }}
      user-auth: ${{ steps.changes.outputs.user-auth }}
      github-auth: ${{ steps.changes.outputs.github-auth }}
      api-key-manager: ${{ steps.changes.outputs.api-key-manager }}
      paypal-handler: ${{ steps.changes.outputs.paypal-handler }}
      subscription-manager: ${{ steps.changes.outputs.subscription-manager }}
      credit-manager: ${{ steps.changes.outputs.credit-manager }}
      blog-manager: ${{ steps.changes.outputs.blog-manager }}
      support-ticket: ${{ steps.changes.outputs.support-ticket }}
      recaptcha-verify: ${{ steps.changes.outputs.recaptcha-verify }}
      any-lambda: ${{ steps.changes.outputs.any-lambda }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect Changed Files
        id: changes
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          echo "Changed files: $CHANGED_FILES"

          # Check each Lambda directory
          check_lambda() {
            local name=$1
            local dir=$2
            if echo "$CHANGED_FILES" | grep -q "^aws-lambda/$dir/"; then
              echo "$name=true" >> $GITHUB_OUTPUT
              echo "✅ $name changed"
            else
              echo "$name=false" >> $GITHUB_OUTPUT
            fi
          }

          check_lambda "security-crawler" "security-crawler"
          check_lambda "audit-status" "audit-status"
          check_lambda "report-generator" "report-generator"
          check_lambda "url-validator" "url-validator"
          check_lambda "user-auth" "user-auth"
          check_lambda "github-auth" "github-auth"
          check_lambda "api-key-manager" "api-key-manager"
          check_lambda "paypal-handler" "paypal-handler"
          check_lambda "subscription-manager" "subscription-manager"
          check_lambda "credit-manager" "credit-manager"
          check_lambda "blog-manager" "blog-manager"
          check_lambda "support-ticket" "support-ticket"
          check_lambda "recaptcha-verify" "recaptcha-verify"

          # Check if any Lambda changed
          if echo "$CHANGED_FILES" | grep -q "^aws-lambda/"; then
            echo "any-lambda=true" >> $GITHUB_OUTPUT
            echo "✅ Lambda files changed - deployment needed"
          else
            echo "any-lambda=false" >> $GITHUB_OUTPUT
            echo "ℹ️  No Lambda files changed"
          fi

  # =============================================================================
  # LAMBDA DEPLOYMENT - US Region (us-east-1)
  # =============================================================================
  deploy-lambda-us:
    name: Deploy Lambda Functions (US)
    runs-on: ubuntu-latest
    needs: [validate, deploy-frontend, detect-changes]
    if: |
      always() &&
      needs.validate.result == 'success' &&
      (github.event.inputs.deploy_lambdas == 'true' ||
       contains(github.event.head_commit.message, '[deploy-lambda]') ||
       needs.detect-changes.outputs.any-lambda == 'true') &&
      (github.event.inputs.deploy_region == 'both' || github.event.inputs.deploy_region == 'us-east-1' || github.event.inputs.deploy_region == '')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION_US }}

      # Core Security Functions - Only deploy if changed or forced
      - name: Deploy Security Crawler Lambda (US)
        if: needs.detect-changes.outputs.security-crawler == 'true' || github.event.inputs.deploy_lambdas == 'true'
        run: |
          echo "Deploying Security Crawler Lambda to US region..."
          cd aws-lambda/security-crawler
          zip -r lambda.zip *.py
          aws lambda update-function-code \
            --function-name aivedha-guardian-security-crawler \
            --zip-file fileb://lambda.zip \
            --region ${{ env.AWS_REGION_US }}
          rm lambda.zip

      - name: Deploy Audit Status Lambda (US)
        if: needs.detect-changes.outputs.audit-status == 'true' || github.event.inputs.deploy_lambdas == 'true'
        run: |
          echo "Deploying Audit Status Lambda to US region..."
          cd aws-lambda/audit-status
          zip -j lambda.zip lambda_function.py
          aws lambda update-function-code \
            --function-name aivedha-guardian-audit-status \
            --zip-file fileb://lambda.zip \
            --region ${{ env.AWS_REGION_US }}
          rm lambda.zip

      - name: Deploy Report Generator Lambda (US)
        if: needs.detect-changes.outputs.report-generator == 'true' || github.event.inputs.deploy_lambdas == 'true'
        run: |
          echo "Deploying Report Generator Lambda to US region..."
          cd aws-lambda/report-generator
          zip -j lambda.zip lambda_function.py
          aws lambda update-function-code \
            --function-name aivedha-guardian-report-generator \
            --zip-file fileb://lambda.zip \
            --region ${{ env.AWS_REGION_US }}
          rm lambda.zip

      - name: Deploy URL Validator Lambda (US)
        if: needs.detect-changes.outputs.url-validator == 'true' || github.event.inputs.deploy_lambdas == 'true'
        run: |
          echo "Deploying URL Validator Lambda to US region..."
          cd aws-lambda/url-validator
          zip -j lambda.zip lambda_function.py
          aws lambda update-function-code \
            --function-name aivedha-guardian-url-validator \
            --zip-file fileb://lambda.zip \
            --region ${{ env.AWS_REGION_US }}
          rm lambda.zip

      # Authentication Functions
      - name: Deploy User Auth Lambda (US)
        if: needs.detect-changes.outputs.user-auth == 'true' || github.event.inputs.deploy_lambdas == 'true'
        run: |
          echo "Deploying User Auth Lambda to US region..."
          cd aws-lambda/user-auth
          zip -j lambda.zip lambda_function.py
          aws lambda update-function-code \
            --function-name aivedha-guardian-user-auth \
            --zip-file fileb://lambda.zip \
            --region ${{ env.AWS_REGION_US }}
          rm lambda.zip

      - name: Deploy GitHub Auth Lambda (US)
        if: needs.detect-changes.outputs.github-auth == 'true' || github.event.inputs.deploy_lambdas == 'true'
        run: |
          echo "Deploying GitHub Auth Lambda to US region..."
          cd aws-lambda/github-auth
          zip -j lambda.zip lambda_function.py
          aws lambda update-function-code \
            --function-name aivedha-guardian-github-auth \
            --zip-file fileb://lambda.zip \
            --region ${{ env.AWS_REGION_US }}
          rm lambda.zip

      - name: Deploy API Key Manager Lambda (US)
        if: needs.detect-changes.outputs.api-key-manager == 'true' || github.event.inputs.deploy_lambdas == 'true'
        run: |
          echo "Deploying API Key Manager Lambda to US region..."
          cd aws-lambda/api-key-manager
          zip -j lambda.zip lambda_function.py
          aws lambda update-function-code \
            --function-name aivedha-guardian-api-key-manager \
            --zip-file fileb://lambda.zip \
            --region ${{ env.AWS_REGION_US }}
          rm lambda.zip

      # Payment Functions
      - name: Deploy PayPal Handler Lambda (US)
        if: needs.detect-changes.outputs.paypal-handler == 'true' || github.event.inputs.deploy_lambdas == 'true'
        run: |
          echo "Deploying PayPal Handler Lambda to US region..."
          cd aws-lambda/paypal-handler
          zip -j lambda.zip lambda_function.py
          aws lambda update-function-code \
            --function-name aivedha-guardian-paypal-handler \
            --zip-file fileb://lambda.zip \
            --region ${{ env.AWS_REGION_US }}
          rm lambda.zip

      - name: Deploy Subscription Manager Lambda (US)
        if: needs.detect-changes.outputs.subscription-manager == 'true' || github.event.inputs.deploy_lambdas == 'true'
        run: |
          echo "Deploying Subscription Manager Lambda to US region..."
          cd aws-lambda/subscription-manager
          zip -j lambda.zip lambda_function.py
          aws lambda update-function-code \
            --function-name aivedha-guardian-subscription-manager \
            --zip-file fileb://lambda.zip \
            --region ${{ env.AWS_REGION_US }}
          rm lambda.zip

      - name: Deploy Credit Manager Lambda (US)
        if: needs.detect-changes.outputs.credit-manager == 'true' || github.event.inputs.deploy_lambdas == 'true'
        run: |
          echo "Deploying Credit Manager Lambda to US region..."
          cd aws-lambda/credit-manager
          zip -j lambda.zip lambda_function.py
          aws lambda update-function-code \
            --function-name aivedha-guardian-credit-manager \
            --zip-file fileb://lambda.zip \
            --region ${{ env.AWS_REGION_US }}
          rm lambda.zip

      # Utility Functions
      - name: Deploy Blog Manager Lambda (US)
        if: needs.detect-changes.outputs.blog-manager == 'true' || github.event.inputs.deploy_lambdas == 'true'
        run: |
          echo "Deploying Blog Manager Lambda to US region..."
          cd aws-lambda/blog-manager
          zip -j lambda.zip lambda_function.py
          aws lambda update-function-code \
            --function-name aivedha-guardian-blog-manager \
            --zip-file fileb://lambda.zip \
            --region ${{ env.AWS_REGION_US }}
          rm lambda.zip

      - name: Deploy Support Ticket Lambda (US)
        if: needs.detect-changes.outputs.support-ticket == 'true' || github.event.inputs.deploy_lambdas == 'true'
        run: |
          echo "Deploying Support Ticket Lambda to US region..."
          cd aws-lambda/support-ticket
          zip -j lambda.zip lambda_function.py
          aws lambda update-function-code \
            --function-name aivedha-support-ticket-manager \
            --zip-file fileb://lambda.zip \
            --region ${{ env.AWS_REGION_US }}
          rm lambda.zip

      - name: Deploy reCAPTCHA Verify Lambda (US)
        if: needs.detect-changes.outputs.recaptcha-verify == 'true' || github.event.inputs.deploy_lambdas == 'true'
        run: |
          echo "Deploying reCAPTCHA Verify Lambda to US region..."
          cd aws-lambda/recaptcha-verify
          if [ -f "lambda_function.py" ]; then
            zip -j lambda.zip lambda_function.py
          elif [ -f "recaptcha-verify.py" ]; then
            zip -j lambda.zip recaptcha-verify.py
          fi
          aws lambda update-function-code \
            --function-name aivedha-guardian-recaptcha-verify \
            --zip-file fileb://lambda.zip \
            --region ${{ env.AWS_REGION_US }}
          rm -f lambda.zip

      - name: US Region Deployment Complete
        run: |
          echo "=========================================="
          echo "US REGION (us-east-1) DEPLOYMENT COMPLETE"
          echo "Static IP: ${{ env.USA_STATIC_IP }}"
          echo "=========================================="

  # =============================================================================
  # LAMBDA DEPLOYMENT - India Region (ap-south-1)
  # =============================================================================
  deploy-lambda-india:
    name: Deploy Lambda Functions (India)
    runs-on: ubuntu-latest
    needs: [validate, deploy-frontend, detect-changes]
    if: |
      always() &&
      needs.validate.result == 'success' &&
      (github.event.inputs.deploy_lambdas == 'true' ||
       contains(github.event.head_commit.message, '[deploy-lambda]') ||
       needs.detect-changes.outputs.any-lambda == 'true') &&
      (github.event.inputs.deploy_region == 'both' || github.event.inputs.deploy_region == 'ap-south-1')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION_IN }}

      # Core Security Functions - INDIA REGION
      # Note: Same function names as US region - API Gateway is different
      # Uses continue-on-error since India Lambdas may not exist yet
      - name: Deploy Security Crawler Lambda (India)
        if: needs.detect-changes.outputs.security-crawler == 'true' || github.event.inputs.deploy_lambdas == 'true'
        continue-on-error: true
        run: |
          echo "Deploying Security Crawler Lambda to India region..."
          cd aws-lambda/security-crawler
          zip -r lambda.zip *.py
          if aws lambda get-function --function-name aivedha-guardian-security-crawler --region ${{ env.AWS_REGION_IN }} 2>/dev/null; then
            aws lambda update-function-code \
              --function-name aivedha-guardian-security-crawler \
              --zip-file fileb://lambda.zip \
              --region ${{ env.AWS_REGION_IN }}
            echo "✅ Security Crawler Lambda updated in India region"
          else
            echo "⚠️  Lambda aivedha-guardian-security-crawler does not exist in India region - skipping"
          fi
          rm lambda.zip

      - name: Deploy Audit Status Lambda (India)
        if: needs.detect-changes.outputs.audit-status == 'true' || github.event.inputs.deploy_lambdas == 'true'
        continue-on-error: true
        run: |
          echo "Deploying Audit Status Lambda to India region..."
          cd aws-lambda/audit-status
          zip -j lambda.zip lambda_function.py
          if aws lambda get-function --function-name aivedha-guardian-audit-status --region ${{ env.AWS_REGION_IN }} 2>/dev/null; then
            aws lambda update-function-code \
              --function-name aivedha-guardian-audit-status \
              --zip-file fileb://lambda.zip \
              --region ${{ env.AWS_REGION_IN }}
            echo "✅ Audit Status Lambda updated in India region"
          else
            echo "⚠️  Lambda aivedha-guardian-audit-status does not exist in India region - skipping"
          fi
          rm lambda.zip

      - name: Deploy Report Generator Lambda (India)
        if: needs.detect-changes.outputs.report-generator == 'true' || github.event.inputs.deploy_lambdas == 'true'
        continue-on-error: true
        run: |
          echo "Deploying Report Generator Lambda to India region..."
          cd aws-lambda/report-generator
          zip -j lambda.zip lambda_function.py
          if aws lambda get-function --function-name aivedha-guardian-report-generator --region ${{ env.AWS_REGION_IN }} 2>/dev/null; then
            aws lambda update-function-code \
              --function-name aivedha-guardian-report-generator \
              --zip-file fileb://lambda.zip \
              --region ${{ env.AWS_REGION_IN }}
            echo "✅ Report Generator Lambda updated in India region"
          else
            echo "⚠️  Lambda aivedha-guardian-report-generator does not exist in India region - skipping"
          fi
          rm lambda.zip

      - name: Deploy URL Validator Lambda (India)
        if: needs.detect-changes.outputs.url-validator == 'true' || github.event.inputs.deploy_lambdas == 'true'
        continue-on-error: true
        run: |
          echo "Deploying URL Validator Lambda to India region..."
          cd aws-lambda/url-validator
          zip -j lambda.zip lambda_function.py
          if aws lambda get-function --function-name aivedha-guardian-url-validator --region ${{ env.AWS_REGION_IN }} 2>/dev/null; then
            aws lambda update-function-code \
              --function-name aivedha-guardian-url-validator \
              --zip-file fileb://lambda.zip \
              --region ${{ env.AWS_REGION_IN }}
            echo "✅ URL Validator Lambda updated in India region"
          else
            echo "⚠️  Lambda aivedha-guardian-url-validator does not exist in India region - skipping"
          fi
          rm lambda.zip

      - name: India Region Deployment Complete
        run: |
          echo "=========================================="
          echo "INDIA REGION (ap-south-1) DEPLOYMENT COMPLETE"
          echo "Static IP: ${{ env.INDIA_STATIC_IP }}"
          echo "=========================================="

  # =============================================================================
  # POST-DEPLOYMENT ENDPOINT VALIDATION (Dual-Region)
  # =============================================================================
  validate-endpoints:
    name: Validate API Endpoints (Dual-Region)
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-lambda-us, deploy-lambda-india]
    if: |
      always() &&
      (needs.deploy-frontend.result == 'success' || needs.deploy-frontend.result == 'skipped')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Wait for deployment propagation
        run: |
          echo "Waiting 30 seconds for deployment to propagate..."
          sleep 30

      - name: Verify API Gateway Health (Both Regions)
        id: api_health
        run: |
          echo "=========================================="
          echo "API GATEWAY HEALTH CHECK"
          echo "=========================================="

          # Check US API
          echo "Checking US API (api.aivedha.ai)..."
          US_RESPONSE=$(curl -s -w "\n%{http_code}" "https://api.aivedha.ai/api/health" || echo "error\n000")
          US_BODY=$(echo "$US_RESPONSE" | head -n1)
          US_CODE=$(echo "$US_RESPONSE" | tail -n1)

          if [ "$US_CODE" = "200" ]; then
            echo "✅ US API: Healthy ($US_BODY)"
            echo "us_healthy=true" >> $GITHUB_OUTPUT
          else
            echo "❌ US API: Failed (HTTP $US_CODE)"
            echo "us_healthy=false" >> $GITHUB_OUTPUT
          fi

          # Check India API
          echo "Checking India API (api-india.aivedha.ai)..."
          IN_RESPONSE=$(curl -s -w "\n%{http_code}" "https://api-india.aivedha.ai/api/health" || echo "error\n000")
          IN_BODY=$(echo "$IN_RESPONSE" | head -n1)
          IN_CODE=$(echo "$IN_RESPONSE" | tail -n1)

          if [ "$IN_CODE" = "200" ]; then
            echo "✅ India API: Healthy ($IN_BODY)"
            echo "india_healthy=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️  India API: Status $IN_CODE (may be expected if not fully deployed)"
            echo "india_healthy=false" >> $GITHUB_OUTPUT
          fi

          echo "=========================================="

      - name: Validate Endpoints
        id: endpoints
        run: |
          echo "Validating API endpoints..."
          node scripts/validate-endpoints.cjs --env production 2>&1 | tee endpoint-validation.txt
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "endpoint_errors=true" >> $GITHUB_OUTPUT
          else
            echo "endpoint_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Endpoint Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: endpoint-validation-report
          path: endpoint-validation.txt
          retention-days: 7

  # =============================================================================
  # POST-DEPLOYMENT SECURITY AUDIT
  # =============================================================================
  post-deployment-audit:
    name: Post-Deployment Security Audit
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-lambda-us, deploy-lambda-india, validate-endpoints]
    if: |
      always() &&
      (needs.deploy-frontend.result == 'success' || needs.deploy-frontend.result == 'skipped') &&
      github.event.inputs.run_security_audit != 'false'

    steps:
      - name: Run Security Audit via API
        run: |
          echo "=========================================="
          echo "RUNNING POST-DEPLOYMENT SECURITY AUDIT"
          echo "=========================================="

          # Check if API key is configured
          if [ -z "${{ secrets.AIVEDHA_API_KEY }}" ]; then
            echo "WARNING: AIVEDHA_API_KEY secret not configured"
            echo "Skipping automated security audit"
            echo "To enable: Add AIVEDHA_API_KEY secret in GitHub repository settings"
            exit 0
          fi

          # Trigger security audit via API
          AUDIT_RESPONSE=$(curl -s -X POST "https://api.aivedha.ai/api/audit/start" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.AIVEDHA_API_KEY }}" \
            -d '{
              "url": "https://aivedha.ai",
              "userId": "github-ci-cd",
              "userEmail": "aravind@aivibe.in",
              "auditMetadata": {
                "source": "github-ci-cd",
                "workflow": "${{ github.workflow }}",
                "run_id": "${{ github.run_id }}",
                "commit": "${{ github.sha }}"
              }
            }' || echo '{"error": "API request failed"}')

          echo "Audit Response: $AUDIT_RESPONSE"

          # Extract report ID for tracking
          REPORT_ID=$(echo $AUDIT_RESPONSE | jq -r '.report_id // .reportId // "unknown"')
          if [ "$REPORT_ID" != "unknown" ] && [ "$REPORT_ID" != "null" ]; then
            echo "Security audit initiated successfully"
            echo "Report ID: $REPORT_ID"
            echo "View results at: https://aivedha.ai/audit/results/$REPORT_ID"
          else
            echo "Note: Security audit may have started but response was incomplete"
            echo "Check https://aivedha.ai/dashboard for audit status"
          fi

      - name: Verify API Health (Both Regions)
        run: |
          echo "Verifying API health for both regions..."

          # Check US region
          US_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" "https://api.aivedha.ai/api/health" || echo "000")
          echo "US API Health: $US_HEALTH"

          if [ "$US_HEALTH" = "200" ]; then
            echo "✅ US API is healthy"
          else
            echo "❌ WARNING: US API health check failed (HTTP $US_HEALTH)"
          fi

          # Check India region
          IN_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" "https://api-india.aivedha.ai/api/health" || echo "000")
          echo "India API Health: $IN_HEALTH"

          if [ "$IN_HEALTH" = "200" ]; then
            echo "✅ India API is healthy"
          else
            echo "⚠️  India API status: HTTP $IN_HEALTH (may be expected if not fully deployed)"
          fi

  # =============================================================================
  # FAILURE NOTIFICATION (Email Alert)
  # =============================================================================
  notify-failure:
    name: Send Failure Alert
    runs-on: ubuntu-latest
    needs: [validate, deploy-frontend, deploy-lambda-us, deploy-lambda-india, validate-endpoints]
    if: |
      always() &&
      (needs.validate.result == 'failure' ||
       needs.deploy-frontend.result == 'failure' ||
       needs.deploy-lambda-us.result == 'failure' ||
       needs.deploy-lambda-india.result == 'failure' ||
       needs.validate-endpoints.result == 'failure')

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine Failure Details
        id: failure
        run: |
          FAILURES=""
          if [ "${{ needs.validate.result }}" = "failure" ]; then
            FAILURES="$FAILURES- Pre-deployment validation failed\n"
          fi
          if [ "${{ needs.deploy-frontend.result }}" = "failure" ]; then
            FAILURES="$FAILURES- Frontend deployment failed\n"
          fi
          if [ "${{ needs.deploy-lambda-us.result }}" = "failure" ]; then
            FAILURES="$FAILURES- Lambda US deployment failed\n"
          fi
          if [ "${{ needs.deploy-lambda-india.result }}" = "failure" ]; then
            FAILURES="$FAILURES- Lambda India deployment failed\n"
          fi
          if [ "${{ needs.validate-endpoints.result }}" = "failure" ]; then
            FAILURES="$FAILURES- Endpoint validation failed (404 errors)\n"
          fi
          echo "failures<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FAILURES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Email Alert via SES
        run: |
          SUBJECT="[ALERT] AiVedha Guardian Deployment Failed - ${{ github.sha }}"
          BODY="AiVedha Guardian deployment failed.\n\nWorkflow: ${{ github.workflow }}\nRun ID: ${{ github.run_id }}\nCommit: ${{ github.sha }}\nBranch: ${{ github.ref_name }}\n\nFailures:\n${{ steps.failure.outputs.failures }}\n\nView details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          aws ses send-email \
            --from "noreply@aivedha.ai" \
            --destination "ToAddresses=${{ env.ALERT_EMAIL }}" \
            --message "Subject={Data='$SUBJECT',Charset=utf-8},Body={Text={Data='$(echo -e "$BODY")',Charset=utf-8}}" \
            --region ${{ env.AWS_REGION }} || echo "Failed to send email alert"

          echo "Alert email sent to ${{ env.ALERT_EMAIL }}"

  # =============================================================================
  # SUCCESS NOTIFICATION
  # =============================================================================
  notify-success:
    name: Send Success Notification
    runs-on: ubuntu-latest
    needs: [validate, deploy-frontend, deploy-lambda-us, deploy-lambda-india, validate-endpoints, post-deployment-audit]
    if: |
      always() &&
      needs.validate.result == 'success' &&
      (needs.deploy-frontend.result == 'success' || needs.deploy-frontend.result == 'skipped') &&
      (needs.deploy-lambda-us.result == 'success' || needs.deploy-lambda-us.result == 'skipped') &&
      (needs.deploy-lambda-india.result == 'success' || needs.deploy-lambda-india.result == 'skipped') &&
      (needs.validate-endpoints.result == 'success' || needs.validate-endpoints.result == 'skipped')

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Send Success Email (Optional)
        if: github.event.inputs.deploy_lambdas == 'true'
        run: |
          SUBJECT="[SUCCESS] AiVedha Guardian Deployed - ${{ github.sha }}"
          BODY="AiVedha Guardian deployment completed successfully.\n\nWorkflow: ${{ github.workflow }}\nRun ID: ${{ github.run_id }}\nCommit: ${{ github.sha }}\nBranch: ${{ github.ref_name }}\n\nDeployed:\n- Frontend: ${{ needs.deploy-frontend.result }}\n- Lambda US: ${{ needs.deploy-lambda-us.result }}\n- Lambda India: ${{ needs.deploy-lambda-india.result }}\n- Endpoints: ${{ needs.validate-endpoints.result }}\n\nWebsite: https://aivedha.ai\nAPI: https://api.aivedha.ai/api"

          aws ses send-email \
            --from "noreply@aivedha.ai" \
            --destination "ToAddresses=${{ env.ALERT_EMAIL }}" \
            --message "Subject={Data='$SUBJECT',Charset=utf-8},Body={Text={Data='$(echo -e "$BODY")',Charset=utf-8}}" \
            --region ${{ env.AWS_REGION }} || echo "Failed to send success email"

  # =============================================================================
  # DEPLOYMENT SUMMARY & MIRRORING CHECKLIST
  # =============================================================================
  deployment-summary:
    name: Deployment Summary & Checklist
    runs-on: ubuntu-latest
    needs: [increment-version, validate, deploy-frontend, deploy-lambda-us, deploy-lambda-india, validate-endpoints, post-deployment-audit]
    if: always()

    steps:
      - name: Generate Deployment Report
        run: |
          echo "=========================================="
          echo "AIVEDHA GUARDIAN DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo ""
          echo "VERSION: ${{ needs.increment-version.outputs.new_version || 'N/A' }}"
          echo ""
          echo "DEPLOYMENT STATUS:"
          echo "  Version Bump:       ${{ needs.increment-version.result || 'skipped' }}"
          echo "  Validation:         ${{ needs.validate.result }}"
          echo "  Frontend:           ${{ needs.deploy-frontend.result }}"
          echo "  Lambda US:          ${{ needs.deploy-lambda-us.result || 'skipped' }}"
          echo "  Lambda India:       ${{ needs.deploy-lambda-india.result || 'skipped' }}"
          echo "  Endpoint Check:     ${{ needs.validate-endpoints.result || 'skipped' }}"
          echo "  Security Audit:     ${{ needs.post-deployment-audit.result || 'skipped' }}"
          echo ""
          echo "PRODUCTION URLS:"
          echo "  Website:            https://aivedha.ai"
          echo "  API (US):           https://api.aivedha.ai/api"
          echo "  API (India):        https://api-india.aivedha.ai/api"
          echo "  US Health Check:    https://api.aivedha.ai/api/health"
          echo "  India Health Check: https://api-india.aivedha.ai/api/health"
          echo ""
          echo "STATIC IPs:"
          echo "  USA (us-east-1):    ${{ env.USA_STATIC_IP }}"
          echo "  India (ap-south-1): ${{ env.INDIA_STATIC_IP }}"
          echo ""
          echo "=========================================="
          echo "DUAL-REGION MIRRORING CHECKLIST"
          echo "=========================================="
          echo ""
          echo "[ ] Lambda code identical in both regions"
          echo "[ ] Environment variables configured in both regions"
          echo "[ ] DynamoDB accessed from us-east-1 (single source of truth)"
          echo "[ ] S3 bucket access configured for both regions"
          echo "[ ] API Gateway routing configured"
          echo "[ ] Static IPs assigned and verified"
          echo "[ ] VPC and NAT Gateway configured in India"
          echo "[ ] Security Groups properly configured"
          echo "[ ] CloudWatch logs enabled in both regions"
          echo ""
          echo "POST-DEPLOYMENT VERIFICATION:"
          echo "[ ] Run security audit on https://aivedha.ai"
          echo "[ ] Verify API health endpoint"
          echo "[ ] Check CloudWatch for errors"
          echo "[ ] Monitor DynamoDB metrics"
          echo ""
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "Commit: ${{ github.sha }}"
          echo "Workflow Run: ${{ github.run_id }}"
          echo "=========================================="
